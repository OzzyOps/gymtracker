<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <title>Gym Tracker</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0b0f17;
      --muted:#6b7280;
      --line:#e6e8ee;
      --shadow: 0 12px 30px rgba(17, 24, 39, .08);
      --r: 18px;

      --btn:#0b0f17;
      --btnText:#ffffff;
      --btnSoft:#f2f3f7;
      --danger:#e11d48;
      --ok:#16a34a;
      --warn:#f59e0b;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background: radial-gradient(900px 500px at 10% -10%, rgba(0,0,0,.03), transparent 60%),
                  radial-gradient(900px 500px at 110% 10%, rgba(0,0,0,.03), transparent 60%),
                  var(--bg);
      -webkit-tap-highlight-color: transparent;
    }
    .app{max-width:1040px;margin:0 auto;padding-bottom:98px;}
    header{
      position:sticky; top:0; z-index:20;
      background: rgba(246,247,251,.86);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .top{
      padding:14px 14px 12px;
      display:flex;align-items:center;gap:12px;
    }
    .logo{
      width:38px;height:38px;border-radius:14px;
      background: #fff;
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      display:grid;place-items:center;
      flex:0 0 auto;
    }
    .logo span{font-size:18px}
    .titleblock{min-width:0}
    .h1{font-weight:900;letter-spacing:.2px;font-size:16px;line-height:1.1;margin:0}
    .sub{color:var(--muted);font-size:12px;margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .chip{
      margin-left:auto;
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
      color:var(--muted);
      font-size:12px;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:#22c55e; box-shadow:0 0 0 6px rgba(34,197,94,.10)}
    main{padding:14px}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card + .card{margin-top:12px}
    .card-h{
      padding:12px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.02);
    }
    .card-h .t{font-weight:900}
    .card-h .k{color:var(--muted);font-size:12px}
    .card-b{padding:14px}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .right{margin-left:auto}

    button,input,select,textarea{font:inherit;color:inherit}
    input,select,textarea{
      width:100%;
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:11px 12px;
      outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:#c7cbd8; box-shadow: 0 0 0 4px rgba(11,15,23,.06)}
    textarea{min-height:92px;resize:vertical}

    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    label{color:var(--muted);font-size:12px}

    .split{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .split3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:720px){.split3{grid-template-columns:1fr}}
    @media (max-width:520px){.split{grid-template-columns:1fr}}

    .btn{
      border:1px solid var(--line);
      background: var(--btnSoft);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .btn.primary{background: var(--btn); color: var(--btnText); border-color: var(--btn)}
    .btn.danger{background:#fff; color:var(--danger); border-color: rgba(225,29,72,.25)}
    .btn.ok{background:#fff; color:var(--ok); border-color: rgba(22,163,74,.25)}
    .btn.warn{background:#fff; color:var(--warn); border-color: rgba(245,158,11,.25)}
    .btn.small{padding:8px 10px;border-radius:12px}
    .btn:active{transform:translateY(1px)}
    .btn:disabled{opacity:.55; cursor:not-allowed}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      font-size:12px;
    }
    .mono{font-variant-numeric: tabular-nums; font-feature-settings:"tnum" 1}
    .hint{color:var(--muted);font-size:12px;line-height:1.4;margin-top:8px}
    .divider{height:1px;background:var(--line);margin:12px 0}

    .item{
      padding:12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
    }
    .item + .item{margin-top:10px}
    .empty{
      padding:16px;
      border:1px dashed #d7dbe6;
      border-radius:16px;
      background:#fff;
      color:var(--muted);
    }

    table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:14px}
    th,td{padding:8px 8px;border-bottom:1px solid var(--line);text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:800;background: rgba(0,0,0,.02)}
    tr:last-child td{border-bottom:none}
    .setInput{width: 96px; padding: 8px 10px; border-radius: 12px;}
    .setInput.small{width:76px}

    /* Bottom nav */
    .nav{
      position:fixed;left:0;right:0;bottom:0;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(246,247,251,.90);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--line);
      z-index:30;
    }
    .nav-inner{
      max-width:1040px;margin:0 auto;
      display:grid;grid-template-columns:repeat(6,1fr);
      gap:10px;
    }
    @media (max-width:860px){ .nav-inner{grid-template-columns:repeat(4,1fr)} .hide-sm{display:none} }
    .tab{
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:5px;
      padding:10px 10px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      border-color:#0b0f17;
      color:#0b0f17;
      background:#fff;
      box-shadow: 0 8px 20px rgba(11,15,23,.08);
    }
    .tab .i{font-size:16px}
    .tab .l{font-size:11px;font-weight:800}

    /* Floating timer */
    .timer-bubble{
      position:fixed;right:14px;bottom:108px;z-index:40;
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow: var(--shadow);
      cursor:pointer;
      user-select:none;
    }
    .timer-bubble .time{font-weight:950;letter-spacing:.4px;font-size:14px;}
    .timer-bubble .label{font-size:12px;color:var(--muted)}
    .timer-bubble .dot2{
      width:10px;height:10px;border-radius:99px;
      background:#0b0f17;
      box-shadow:0 0 0 6px rgba(11,15,23,.08);
    }

    /* Sheet / modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.40);display:none;z-index:50;}
    .overlay.show{display:block}
    .sheet{
      position:absolute;left:0;right:0;bottom:0;
      max-width:1040px;margin:0 auto;
      border-radius:22px 22px 0 0;
      border:1px solid var(--line);
      background:#fff;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sheet-h{
      padding:12px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.02);
    }
    .grab{width:44px;height:5px;border-radius:99px;background: rgba(17,24,39,.18); margin:10px auto 0;}
    .sheet-b{padding:14px 14px 20px}
    .chartwrap{
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
      padding:10px;
    }
    canvas{width:100%; height:220px; display:block}

    /* Suggest dropdown */
    .suggest{
      position:relative;
    }
    .suggest-list{
      position:absolute;left:0;right:0;top:calc(100% + 6px);
      background:#fff;border:1px solid var(--line);border-radius:14px;
      box-shadow: var(--shadow);
      overflow:hidden;
      z-index:80;
      max-height:260px;
      overflow:auto;
    }
    .suggest-item{
      padding:10px 12px;
      cursor:pointer;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid var(--line);
    }
    .suggest-item:last-child{border-bottom:none}
    .suggest-item:hover{background:rgba(0,0,0,.02)}
    .star{font-size:14px}
    .kbd{color:var(--muted);font-size:12px}

    /* Snackbar */
    .snack{
      position:fixed;left:14px;right:14px;bottom:102px;z-index:60;
      max-width:560px;margin:0 auto;
      border:1px solid var(--line);
      background:#fff;
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:10px 12px;
      display:none;
      align-items:center;justify-content:space-between;gap:10px;
    }
    .snack.show{display:flex}
  </style>
</head>

<body>
<header>
  <div class="top">
    <div class="logo"><span>üèãÔ∏è</span></div>
    <div class="titleblock">
      <div class="h1">Gym Tracker</div>
      <div class="sub">Workouts ‚Ä¢ templates ‚Ä¢ progress ‚Ä¢ cardio ‚Ä¢ glucose ‚Ä¢ exports</div>
    </div>
    <div class="chip"><span class="dot"></span><span id="saveStatus">Saved</span></div>
  </div>
</header>

<div class="app">
  <main id="main"></main>
</div>

<!-- Floating rest timer -->
<div class="timer-bubble" id="timerBubble" title="Tap for timers">
  <span class="dot2"></span>
  <div>
    <div class="time mono" id="timerBubbleTime">01:00</div>
    <div class="label" id="timerBubbleLabel">Rest preset 01:00</div>
  </div>
</div>

<!-- Overlay / Sheet -->
<div class="overlay" id="overlay">
  <div class="sheet">
    <div class="grab"></div>
    <div class="sheet-h">
      <div>
        <div style="font-weight:950" id="sheetTitle">Sheet</div>
        <div id="sheetKicker" style="color:var(--muted);font-size:12px;margin-top:2px"></div>
      </div>
      <button class="btn small" id="sheetClose">Close</button>
    </div>
    <div class="sheet-b" id="sheetBody"></div>
  </div>
</div>

<!-- Snackbar -->
<div class="snack" id="snack">
  <div id="snackText" style="font-size:13px"></div>
  <button class="btn small" id="snackUndo">Undo</button>
</div>

<!-- Bottom nav -->
<div class="nav">
  <div class="nav-inner">
    <div class="tab active" data-tab="workout"><div class="i">üìù</div><div class="l">Workout</div></div>
    <div class="tab" data-tab="history"><div class="i">üóìÔ∏è</div><div class="l">History</div></div>
    <div class="tab" data-tab="progress"><div class="i">üìà</div><div class="l">Progress</div></div>
    <div class="tab" data-tab="library"><div class="i">‚≠ê</div><div class="l">Library</div></div>
    <div class="tab hide-sm" data-tab="tools"><div class="i">üß∞</div><div class="l">Tools</div></div>
    <div class="tab hide-sm" data-tab="settings"><div class="i">‚öôÔ∏è</div><div class="l">Settings</div></div>
  </div>
</div>

<script>
/* =========================================================
   Gym Tracker (God Mode) - Single page PWA
   - White "Apple style" UI
   - Strength sets + smart quick actions
   - Treadmill cardio fields
   - Workout templates + custom templates
   - Exercise library + favourites + autocomplete
   - Analytics: strength (best/e1RM/volume/week), cardio trends, glucose trends, bodyweight
   - Timers: Rest preset 1/2/3 (manual, resets after finish), Stopwatch, Interval timer
   - Export/Import JSON, Export CSV
   - Safety: lock completed workouts, undo delete, search history
   ========================================================= */

const STORAGE_KEY = "gym_tracker_godmode_v1";
const uid = () => Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
const clamp = (n,a,b)=> Math.max(a, Math.min(b,n));

function todayISO(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function formatUKDate(iso){
  if(!iso || typeof iso !== "string" || !iso.includes("-")) return "";
  const [y,m,d] = iso.split("-");
  return `${d}/${m}/${y}`;
}
function formatUKShort(iso){
  if(!iso || typeof iso !== "string" || !iso.includes("-")) return "";
  const [,m,d] = iso.split("-");
  return `${d}/${m}`;
}
function normalizeName(s){
  return (s || "").trim().toLowerCase().replace(/\s+/g," ");
}
function fmtTime(seconds){
  seconds = Math.max(0, Math.floor(seconds));
  const m = String(Math.floor(seconds/60)).padStart(2,"0");
  const s = String(seconds%60).padStart(2,"0");
  return `${m}:${s}`;
}
function defaultWorkoutTitle(dateISO){ return `${formatUKDate(dateISO)} Gym`;}
function isDefaultTitle(title){ return /^\d{2}\/\d{2}\/\d{4}\s+Gym$/i.test((title||"").trim()); }
function startOfWeekMonday(dateISO){
  const d = new Date(dateISO + "T00:00:00");
  const day = (d.getDay() + 6) % 7; // Monday=0
  d.setDate(d.getDate() - day);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function safeNumber(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }

const defaultData = () => ({
  settings:{
    unit:"kg",
    restPreset:60,  // 60/120/180
    barWeight:20,
    plates:[25,20,15,10,5,2.5,1.25],
  },
  // exercise library (suggestions + favourites)
  library:{
    exercises:[
      {id:uid(), name:"Bench Press", type:"Strength", category:"Chest", favorite:true},
      {id:uid(), name:"Squat", type:"Strength", category:"Legs", favorite:true},
      {id:uid(), name:"Deadlift", type:"Strength", category:"Back", favorite:false},
      {id:uid(), name:"Overhead Press", type:"Strength", category:"Shoulders", favorite:false},
      {id:uid(), name:"Lat Pulldown", type:"Strength", category:"Back", favorite:false},
      {id:uid(), name:"Treadmill", type:"Treadmill", category:"Cardio", favorite:true},
    ]
  },
  templates:[
    {id:uid(), name:"Push (simple)", items:[
      {type:"Strength", name:"Bench Press"},
      {type:"Strength", name:"Overhead Press"},
      {type:"Strength", name:"Triceps Pushdown"},
    ]},
    {id:uid(), name:"Pull (simple)", items:[
      {type:"Strength", name:"Lat Pulldown"},
      {type:"Strength", name:"Barbell Row"},
      {type:"Strength", name:"Biceps Curl"},
    ]},
    {id:uid(), name:"Legs (simple)", items:[
      {type:"Strength", name:"Squat"},
      {type:"Strength", name:"Romanian Deadlift"},
      {type:"Strength", name:"Leg Press"},
    ]},
    {id:uid(), name:"Cardio (treadmill)", items:[
      {type:"Treadmill", name:"Treadmill"}
    ]}
  ],
  workouts:[],
  measurements:[] // bodyweight / waist / notes
});

function loadData(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return defaultData();
    const d = JSON.parse(raw);
    if(!d || typeof d !== "object") return defaultData();

    d.settings ??= defaultData().settings;
    d.settings.unit ??= "kg";
    d.settings.restPreset ??= 60;
    d.settings.barWeight ??= 20;
    d.settings.plates ??= [25,20,15,10,5,2.5,1.25];

    d.library ??= defaultData().library;
    d.library.exercises ??= defaultData().library.exercises;
    if(!Array.isArray(d.library.exercises)) d.library.exercises = defaultData().library.exercises;

    d.templates ??= defaultData().templates;
    if(!Array.isArray(d.templates)) d.templates = defaultData().templates;

    d.workouts ??= [];
    if(!Array.isArray(d.workouts)) d.workouts = [];

    d.measurements ??= [];
    if(!Array.isArray(d.measurements)) d.measurements = [];

    // normalize workouts
    for(const w of d.workouts){
      w.id ??= uid();
      w.dateISO ??= todayISO();
      w.lockToToday ??= false;
      w.title = (w.title && String(w.title).trim()) ? w.title : defaultWorkoutTitle(w.dateISO);
      w.notes ??= "";
      w.bgStart ??= "";
      w.bgEnd ??= "";
      w.completedAt ??= null;
      w.locked ??= false;
      w.items ??= w.exercises ??= [];
      if(!Array.isArray(w.items)) w.items = [];

      for(const it of w.items){
        it.id ??= uid();
        it.type ??= "Strength";
        it.name ??= "";
        it.notes ??= "";
        it.sets ??= [];
        if(!Array.isArray(it.sets)) it.sets = [];
        it.cardio ??= { mode:"Walk", incline:"", calories:"", minutes:"", speed:"" };
        // normalize sets
        for(const s of it.sets){
          s.id ??= uid();
          s.weight = safeNumber(s.weight);
          s.reps = safeNumber(s.reps);
          s.rpe = (s.rpe === "" || s.rpe == null) ? null : safeNumber(s.rpe);
        }
      }
    }

    // normalize measurements
    for(const m of d.measurements){
      m.id ??= uid();
      m.dateISO ??= todayISO();
      m.weight ??= "";
      m.waist ??= "";
      m.notes ??= "";
    }

    return d;
  }catch(e){
    return defaultData();
  }
}

const state = {
  data: loadData(),
  tab:"workout",
  activeWorkoutId:null,

  // timers
  rest:{ preset:60, remaining:60, isRunning:false, interval:null },
  stopwatch:{ running:false, startTs:null, elapsed:0, interval:null },
  intervalTimer:{
    running:false,
    phase:"work", // work/rest
    round:1,
    rounds:6,
    workSec:30,
    restSec:30,
    remaining:30,
    interval:null
  },

  // sheet UI
  sheet:{ mode:"timer", payload:null },

  // suggestions dropdown
  suggest:{ open:false, matches:[], anchorId:null },

  // undo stack
  undo:{ action:null, timeout:null },

  ui:{ focusId:null },
};

const main = document.getElementById("main");
const overlay = document.getElementById("overlay");
const sheetBody = document.getElementById("sheetBody");
const sheetTitle = document.getElementById("sheetTitle");
const sheetKicker = document.getElementById("sheetKicker");
const saveStatus = document.getElementById("saveStatus");
const timerBubbleTime = document.getElementById("timerBubbleTime");
const timerBubbleLabel = document.getElementById("timerBubbleLabel");

const snack = document.getElementById("snack");
const snackText = document.getElementById("snackText");
const snackUndo = document.getElementById("snackUndo");

function setSaved(text){ saveStatus.textContent = text; }
function saveSoon(){
  clearTimeout(saveSoon._t);
  saveSoon._t = setTimeout(()=>{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));
    setSaved("Saved");
  }, 250);
}
function touchSave(){ setSaved("Saving..."); saveSoon(); }

function el(tag, attrs={}, children=[]){
  const n = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs)){
    if(k === "class") n.className = v;
    else if(k === "html") n.innerHTML = v;
    else if(k.startsWith("on") && typeof v === "function") n.addEventListener(k.slice(2), v);
    else if(v != null) n.setAttribute(k, v);
  }
  (Array.isArray(children)?children:[children]).forEach(c=>{
    if(c==null) return;
    if(typeof c === "string") n.appendChild(document.createTextNode(c));
    else n.appendChild(c);
  });
  return n;
}

/* -----------------------------
   Undo snackbar
------------------------------ */
function showUndo(message, action){
  state.undo.action = action;
  snackText.textContent = message;
  snack.classList.add("show");
  clearTimeout(state.undo.timeout);
  state.undo.timeout = setTimeout(()=>{
    snack.classList.remove("show");
    state.undo.action = null;
  }, 6500);
}
snackUndo.addEventListener("click", ()=>{
  if(state.undo.action){
    state.undo.action();
    state.undo.action = null;
    touchSave();
    render();
  }
  snack.classList.remove("show");
});

/* -----------------------------
   Sheet modal
------------------------------ */
function openSheet(title, kicker, bodyNode){
  sheetTitle.textContent = title;
  sheetKicker.textContent = kicker || "";
  sheetBody.innerHTML = "";
  if(bodyNode) sheetBody.appendChild(bodyNode);
  overlay.classList.add("show");
}
function closeSheet(){
  overlay.classList.remove("show");
  state.suggest.open = false;
}
document.getElementById("sheetClose").addEventListener("click", closeSheet);
overlay.addEventListener("click",(e)=>{ if(e.target===overlay) closeSheet(); });

/* -----------------------------
   Workout helpers
------------------------------ */
function createWorkout(dateISO){
  const d = dateISO || todayISO();
  const w = {
    id: uid(),
    dateISO: d,
    lockToToday: false,
    title: defaultWorkoutTitle(d),
    notes:"",
    bgStart:"",
    bgEnd:"",
    completedAt:null,
    locked:false,
    items:[]
  };
  state.data.workouts.push(w);
  return w;
}
function ensureActiveWorkout(){
  const ws = state.data.workouts;
  if(state.activeWorkoutId && ws.some(w=>w.id===state.activeWorkoutId)) return;

  if(ws.length){
    const sorted = [...ws].sort((a,b)=> (b.dateISO||"").localeCompare(a.dateISO||""));
    state.activeWorkoutId = sorted[0].id;
  } else {
    const w = createWorkout(todayISO());
    state.activeWorkoutId = w.id;
    touchSave();
  }
}
function getActiveWorkout(){
  ensureActiveWorkout();
  return state.data.workouts.find(w=>w.id===state.activeWorkoutId) || null;
}
function deleteWorkout(id){
  const idx = state.data.workouts.findIndex(w=>w.id===id);
  if(idx<0) return;
  const removed = state.data.workouts.splice(idx,1)[0];
  showUndo(`Workout deleted: ${removed.title}`, ()=>{
    state.data.workouts.splice(idx,0,removed);
    state.activeWorkoutId = removed.id;
  });
  if(state.activeWorkoutId === id){
    state.activeWorkoutId = null;
    ensureActiveWorkout();
  }
}
function addItemToWorkout(w, type, name){
  if(!w) return;
  const it = {
    id: uid(),
    type,
    name: (name||"").trim() || (type==="Treadmill" ? "Treadmill" : ""),
    notes:"",
    sets:[],
    cardio:{ mode:"Walk", incline:"", calories:"", minutes:"", speed:"" }
  };
  w.items.push(it);
  // add to library if new
  const exists = state.data.library.exercises.some(e=> normalizeName(e.name)===normalizeName(it.name) && e.type===type);
  if(!exists && it.name){
    state.data.library.exercises.push({id:uid(), name:it.name, type, category:(type==="Treadmill"?"Cardio":"General"), favorite:false});
  }
  return it;
}
function deleteItem(w, itemId){
  const idx = w.items.findIndex(x=>x.id===itemId);
  if(idx<0) return;
  const removed = w.items.splice(idx,1)[0];
  showUndo(`Deleted: ${removed.name}`, ()=> w.items.splice(idx,0,removed));
}
function addSet(w, itemId, set){
  const it = w.items.find(x=>x.id===itemId);
  if(!it) return;
  it.sets.push({ id: uid(), weight:set.weight, reps:set.reps, rpe:set.rpe });
}

/* -----------------------------
   Smart suggestions & favourites
------------------------------ */
function librarySorted(){
  const list = [...state.data.library.exercises];
  list.sort((a,b)=>{
    const fa = a.favorite?1:0, fb = b.favorite?1:0;
    if(fa!==fb) return fb-fa;
    return a.name.localeCompare(b.name);
  });
  return list;
}
function suggestMatches(query, type){
  const q = normalizeName(query);
  const list = librarySorted().filter(e => (!type || e.type===type));
  if(!q) return list.slice(0,12);
  return list.filter(e=> normalizeName(e.name).includes(q)).slice(0,12);
}
function toggleFavorite(exId){
  const ex = state.data.library.exercises.find(e=>e.id===exId);
  if(!ex) return;
  ex.favorite = !ex.favorite;
  touchSave();
}

/* -----------------------------
   Timers: Rest, Stopwatch, Interval
------------------------------ */
function restSetPreset(seconds){
  const allowed = [60,120,180];
  if(!allowed.includes(seconds)) seconds = 60;
  state.rest.preset = seconds;
  if(!state.rest.isRunning) state.rest.remaining = seconds;
  state.data.settings.restPreset = seconds;
  touchSave();
  updateTimerBubble();
}
function restStart(){
  if(state.rest.isRunning) return;
  state.rest.isRunning = true;
  state.rest.interval = setInterval(()=>{
    state.rest.remaining -= 1;
    if(state.rest.remaining <= 0){
      state.rest.remaining = 0;
      restStop();
      notifyDone();
      // reset to preset automatically
      state.rest.remaining = state.rest.preset;
    }
    updateTimerBubble();
  }, 1000);
  updateTimerBubble();
}
function restPause(){
  if(!state.rest.isRunning) return;
  clearInterval(state.rest.interval);
  state.rest.interval = null;
  state.rest.isRunning = false;
  updateTimerBubble();
}
function restStop(){
  clearInterval(state.rest.interval);
  state.rest.interval = null;
  state.rest.isRunning = false;
  updateTimerBubble();
}
function restReset(){
  restPause();
  state.rest.remaining = state.rest.preset;
  updateTimerBubble();
}

function stopwatchStart(){
  if(state.stopwatch.running) return;
  state.stopwatch.running = true;
  state.stopwatch.startTs = Date.now() - state.stopwatch.elapsed;
  state.stopwatch.interval = setInterval(()=>{
    state.stopwatch.elapsed = Date.now() - state.stopwatch.startTs;
    updateTimerBubble();
    // if sheet open, re-render timer sheet minimally by updating text nodes (we keep it simple)
    const t = document.getElementById("swElapsed");
    if(t) t.textContent = fmtTime(state.stopwatch.elapsed/1000);
  }, 250);
}
function stopwatchPause(){
  if(!state.stopwatch.running) return;
  clearInterval(state.stopwatch.interval);
  state.stopwatch.interval = null;
  state.stopwatch.running = false;
}
function stopwatchReset(){
  stopwatchPause();
  state.stopwatch.elapsed = 0;
  updateTimerBubble();
}

function intervalStart(){
  const it = state.intervalTimer;
  if(it.running) return;
  it.running = true;
  it.interval = setInterval(()=>{
    it.remaining -= 1;
    if(it.remaining <= 0){
      notifyDone();
      if(it.phase === "work"){
        it.phase = "rest";
        it.remaining = it.restSec;
      } else {
        it.phase = "work";
        it.round += 1;
        if(it.round > it.rounds){
          intervalStop();
          it.phase = "work";
          it.round = 1;
          it.remaining = it.workSec;
        } else {
          it.remaining = it.workSec;
        }
      }
    }
    updateTimerBubble();
    const t = document.getElementById("itRemaining");
    if(t) t.textContent = fmtTime(it.remaining);
    const p = document.getElementById("itPhase");
    if(p) p.textContent = `${it.phase.toUpperCase()} ‚Ä¢ Round ${it.round}/${it.rounds}`;
  }, 1000);
  updateTimerBubble();
}
function intervalPause(){
  const it = state.intervalTimer;
  if(!it.running) return;
  clearInterval(it.interval);
  it.interval = null;
  it.running = false;
  updateTimerBubble();
}
function intervalStop(){
  const it = state.intervalTimer;
  clearInterval(it.interval);
  it.interval = null;
  it.running = false;
  updateTimerBubble();
}
function intervalReset(){
  intervalPause();
  const it = state.intervalTimer;
  it.phase = "work";
  it.round = 1;
  it.remaining = it.workSec;
  updateTimerBubble();
}

function notifyDone(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine";
    o.frequency.setValueAtTime(880, ctx.currentTime);
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.18, ctx.currentTime + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.6);
    o.connect(g); g.connect(ctx.destination);
    o.start();
    o.stop(ctx.currentTime + 0.65);
    setTimeout(()=>ctx.close(), 900);
  }catch(e){}
  try{ navigator.vibrate && navigator.vibrate([200,100,200,100,200]); }catch(e){}
}

function updateTimerBubble(){
  // bubble shows rest by default (most used)
  timerBubbleTime.textContent = fmtTime(state.rest.remaining);
  timerBubbleLabel.textContent = state.rest.isRunning ? "Rest running" : `Rest preset ${fmtTime(state.rest.preset)}`;
}

/* -----------------------------
   Analytics
------------------------------ */
function workoutTotals(w){
  let strengthSets=0, volume=0;
  let treadmillMin=0, treadmillCal=0;
  for(const it of w.items){
    if(it.type==="Strength"){
      for(const s of it.sets){
        strengthSets += 1;
        volume += (safeNumber(s.weight) * safeNumber(s.reps));
      }
    }
    if(it.type==="Treadmill"){
      treadmillMin += safeNumber(it.cardio?.minutes);
      treadmillCal += safeNumber(it.cardio?.calories);
    }
  }
  return {strengthSets, volume, treadmillMin, treadmillCal};
}
function exerciseSeries(name){
  const key = normalizeName(name);
  const rows = [];
  for(const w of state.data.workouts){
    let bestWeight = null;
    let bestE1RM = null;
    let vol = 0;

    for(const it of (w.items||[])){
      if(it.type!=="Strength") continue;
      if(normalizeName(it.name) !== key) continue;

      for(const s of (it.sets||[])){
        const weight = safeNumber(s.weight);
        const reps = safeNumber(s.reps);
        if(reps<=0) continue;
        vol += weight*reps;

        if(!bestWeight || weight > bestWeight.weight || (weight === bestWeight.weight && reps > bestWeight.reps)){
          bestWeight = { weight, reps };
        }
        const e1 = weight * (1 + reps/30);
        if(bestE1RM==null || e1 > bestE1RM) bestE1RM = e1;
      }
    }

    if(bestWeight || bestE1RM!=null || vol>0){
      rows.push({
        dateISO: w.dateISO,
        bestWeight: bestWeight ? bestWeight.weight : 0,
        bestReps: bestWeight ? bestWeight.reps : 0,
        bestE1RM: bestE1RM || 0,
        volume: vol
      });
    }
  }
  rows.sort((a,b)=> (a.dateISO||"").localeCompare(b.dateISO||""));
  return rows;
}
function getAllStrengthExerciseNames(){
  const set = new Set();
  for(const w of state.data.workouts){
    for(const it of (w.items||[])){
      if(it.type==="Strength" && it.name?.trim()) set.add(it.name.trim());
    }
  }
  return [...set].sort((a,b)=> a.localeCompare(b));
}
function weeklyTotals(){
  const map = new Map(); // weekStartISO -> {sets, volume, treadmillMin, treadmillCal}
  for(const w of state.data.workouts){
    const wk = startOfWeekMonday(w.dateISO || todayISO());
    const cur = map.get(wk) || {week:wk, sets:0, volume:0, treadmillMin:0, treadmillCal:0};
    const t = workoutTotals(w);
    cur.sets += t.strengthSets;
    cur.volume += t.volume;
    cur.treadmillMin += t.treadmillMin;
    cur.treadmillCal += t.treadmillCal;
    map.set(wk, cur);
  }
  const rows = [...map.values()].sort((a,b)=> a.week.localeCompare(b.week));
  return rows;
}
function glucoseSeries(){
  const rows = [];
  for(const w of state.data.workouts){
    const s = (w.bgStart ?? "").toString().trim();
    const e = (w.bgEnd ?? "").toString().trim();
    if(s==="" && e==="") continue;
    rows.push({
      dateISO: w.dateISO,
      start: s==="" ? null : safeNumber(s),
      end: e==="" ? null : safeNumber(e),
      delta: (s===""||e==="") ? null : (safeNumber(e)-safeNumber(s))
    });
  }
  rows.sort((a,b)=> (a.dateISO||"").localeCompare(b.dateISO||""));
  return rows;
}
function treadmillSeries(){
  const rows = [];
  for(const w of state.data.workouts){
    let minutes=0, calories=0, inclineSum=0, inclineCount=0;
    for(const it of (w.items||[])){
      if(it.type!=="Treadmill") continue;
      minutes += safeNumber(it.cardio?.minutes);
      calories += safeNumber(it.cardio?.calories);
      const inc = it.cardio?.incline;
      if(inc!=="" && inc!=null){
        inclineSum += safeNumber(inc);
        inclineCount += 1;
      }
    }
    if(minutes>0 || calories>0 || inclineCount>0){
      rows.push({
        dateISO: w.dateISO,
        minutes,
        calories,
        inclineAvg: inclineCount? (inclineSum/inclineCount) : 0
      });
    }
  }
  rows.sort((a,b)=> (a.dateISO||"").localeCompare(b.dateISO||""));
  return rows;
}
function measurementsSeries(){
  const rows = [...state.data.measurements].map(m=>({
    dateISO:m.dateISO,
    weight: m.weight===""?null:safeNumber(m.weight),
    waist: m.waist===""?null:safeNumber(m.waist)
  }));
  rows.sort((a,b)=> (a.dateISO||"").localeCompare(b.dateISO||""));
  return rows;
}

/* -----------------------------
   Tiny chart
------------------------------ */
function drawLineChart(canvas, points, opts){
  const ctx = canvas.getContext("2d");
  const dpr = window.devicePixelRatio || 1;
  const cssW = canvas.clientWidth;
  const cssH = canvas.clientHeight;
  canvas.width = Math.floor(cssW * dpr);
  canvas.height = Math.floor(cssH * dpr);
  ctx.scale(dpr, dpr);

  const padL=44, padR=16, padT=14, padB=28;
  const W = cssW - padL - padR;
  const H = cssH - padT - padB;

  ctx.clearRect(0,0,cssW,cssH);
  ctx.fillStyle = "#fff";
  ctx.fillRect(0,0,cssW,cssH);

  if(!points || points.length < 1){
    ctx.fillStyle = "rgba(107,114,128,.9)";
    ctx.font = "12px system-ui";
    ctx.fillText("No data yet.", padL, padT+18);
    return;
  }

  const ys = points.map(p=>p.y);
  let yMin = Math.min(...ys);
  let yMax = Math.max(...ys);
  if(yMin === yMax){ yMin -= 1; yMax += 1; }
  const padding = (yMax - yMin) * 0.12;
  yMin = Math.max(0, yMin - padding);
  yMax = yMax + padding;

  const xCount = points.length;
  const xStep = xCount <= 1 ? 0 : (W / (xCount - 1));
  const xAt = (i)=> padL + i*xStep;
  const yAt = (val)=> padT + (1 - ((val-yMin)/(yMax-yMin))) * H;

  ctx.strokeStyle = "rgba(230,232,238,1)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  for(let i=0;i<=4;i++){
    const y = padT + (H*i/4);
    ctx.moveTo(padL, y);
    ctx.lineTo(padL+W, y);
  }
  ctx.stroke();

  ctx.fillStyle = "rgba(107,114,128,.9)";
  ctx.font = "11px system-ui";
  for(let i=0;i<=4;i++){
    const val = yMax - (yMax-yMin)*(i/4);
    const y = padT + (H*i/4);
    ctx.fillText(String(Math.round(val)), 8, y+4);
  }

  ctx.strokeStyle = "#0b0f17";
  ctx.lineWidth = 2.2;
  ctx.beginPath();
  points.forEach((p,i)=>{
    const x = xAt(i);
    const y = yAt(p.y);
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  });
  ctx.stroke();

  ctx.fillStyle = "#0b0f17";
  points.forEach((p,i)=>{
    const x=xAt(i), y=yAt(p.y);
    ctx.beginPath(); ctx.arc(x,y,3.2,0,Math.PI*2); ctx.fill();
  });

  ctx.fillStyle = "rgba(107,114,128,.9)";
  ctx.font = "11px system-ui";
  const labelIdx = xCount<=2 ? [0,xCount-1] : [0, Math.floor((xCount-1)/2), xCount-1];
  const used = new Set();
  labelIdx.forEach(i=>{
    if(i<0||i>=xCount||used.has(i)) return;
    used.add(i);
    const txt = formatUKShort(points[i].label || "");
    ctx.fillText(txt, xAt(i)-14, padT+H+18);
  });

  ctx.fillStyle = "rgba(11,15,23,.95)";
  ctx.font = "12px system-ui";
  ctx.fillText(opts.title || "", padL, 12);

  ctx.fillStyle = "rgba(107,114,128,.9)";
  ctx.font = "11px system-ui";
  ctx.fillText(opts.subtitle || "", padL, cssH-8);
}

/* -----------------------------
   Templates
------------------------------ */
function applyTemplateToWorkout(w, tpl){
  if(!w || !tpl) return;
  if(w.locked) return alert("This workout is locked (completed). Copy it or start a new one.");
  for(const item of tpl.items){
    addItemToWorkout(w, item.type, item.name);
  }
}

/* -----------------------------
   Locking + summary
------------------------------ */
function completeWorkout(w){
  if(!w) return;
  w.completedAt = new Date().toISOString();
  w.locked = true;
  touchSave();
  openWorkoutSummarySheet(w);
}
function unlockWorkout(w){
  if(!w) return;
  w.locked = false;
  w.completedAt = null;
  touchSave();
  render();
}

function workoutPRs(w){
  // Compare each exercise e1RM to historical best before this workout date
  const prs = [];
  for(const it of w.items){
    if(it.type!=="Strength") continue;
    let bestThis = 0;
    for(const s of it.sets){
      const reps = safeNumber(s.reps);
      const weight = safeNumber(s.weight);
      if(reps<=0) continue;
      const e1 = weight * (1 + reps/30);
      if(e1 > bestThis) bestThis = e1;
    }
    if(bestThis<=0) continue;

    // historical max
    let hist = 0;
    for(const ww of state.data.workouts){
      if(ww.id === w.id) continue;
      for(const ii of (ww.items||[])){
        if(ii.type!=="Strength") continue;
        if(normalizeName(ii.name) !== normalizeName(it.name)) continue;
        for(const ss of (ii.sets||[])){
          const r = safeNumber(ss.reps), wt = safeNumber(ss.weight);
          if(r<=0) continue;
          const e1 = wt * (1 + r/30);
          if(e1 > hist) hist = e1;
        }
      }
    }
    if(bestThis > hist){
      prs.push({ name: it.name, e1rm: bestThis, prev: hist });
    }
  }
  prs.sort((a,b)=> b.e1rm - a.e1rm);
  return prs;
}

function openWorkoutSummarySheet(w){
  const unit = state.data.settings.unit || "kg";
  const t = workoutTotals(w);
  const prs = workoutPRs(w);

  const body = el("div", {}, [
    el("div", {class:"item"}, [
      el("div", {style:"font-weight:950"}, ["Session summary"]),
      el("div", {class:"hint"}, [`${formatUKDate(w.dateISO)} ‚Ä¢ ${w.title}`]),
      el("div", {class:"divider"}),

      el("div", {class:"row"}, [
        el("span",{class:"pill mono"}, [`Strength sets: ${t.strengthSets}`]),
        el("span",{class:"pill mono"}, [`Volume: ${Math.round(t.volume).toLocaleString()} (${unit}√óreps)`]),
      ]),
      el("div", {class:"row", style:"margin-top:8px"}, [
        el("span",{class:"pill mono"}, [`Treadmill min: ${t.treadmillMin}`]),
        el("span",{class:"pill mono"}, [`Calories: ${t.treadmillCal}`]),
      ]),
      el("div", {class:"row", style:"margin-top:8px"}, [
        el("span",{class:"pill"}, [`BG start: ${w.bgStart || "‚Äî"}`]),
        el("span",{class:"pill"}, [`BG end: ${w.bgEnd || "‚Äî"}`]),
        el("span",{class:"pill"}, [
          (()=> {
            const s = w.bgStart===""?null:safeNumber(w.bgStart);
            const e = w.bgEnd===""?null:safeNumber(w.bgEnd);
            if(s==null || e==null) return "Œî BG: ‚Äî";
            const d = e - s;
            return `Œî BG: ${d>=0?"+":""}${d.toFixed(1)}`;
          })()
        ])
      ]),
    ]),

    prs.length ? el("div",{class:"item", style:"margin-top:12px"}, [
      el("div", {style:"font-weight:950"}, ["New PRs (estimated 1RM)"]),
      el("div", {class:"hint"}, ["Based on Epley e1RM."]),
      el("div", {style:"margin-top:10px"}, prs.slice(0,8).map(p =>
        el("div",{class:"row", style:"justify-content:space-between;padding:8px 0;border-bottom:'1px solid var(--line)'"}, [
          el("div",{style:"font-weight:850"}, [p.name]),
          el("div",{class:"mono"}, [
            `${p.e1rm.toFixed(1)} ${unit}` + (p.prev>0? ` (prev ${p.prev.toFixed(1)})` : "")
          ])
        ])
      ))
    ]) : el("div",{class:"item", style:"margin-top:12px"}, [
      el("div",{style:"font-weight:950"}, ["No new PRs today"]),
      el("div",{class:"hint"}, ["Still a win ‚Äî consistency is the game."])
    ]),

    el("div",{class:"row", style:"margin-top:12px"}, [
      el("button",{class:"btn", onclick: closeSheet}, ["Close"]),
      el("button",{class:"btn warn", onclick: ()=>{ unlockWorkout(w); closeSheet(); }}, ["Unlock & edit"]),
    ])
  ]);

  openSheet("Workout complete", "Locked for safety ‚Ä¢ you can unlock if needed", body);
}

/* -----------------------------
   Export / Import
------------------------------ */
function downloadFile(filename, mime, content){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}
function exportJSON(){
  const json = JSON.stringify(state.data, null, 2);
  downloadFile(`gym-tracker-backup-${todayISO()}.json`, "application/json", json);
}
function importJSONFromFile(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
      state.data = loadData();
      state.activeWorkoutId = null;
      ensureActiveWorkout();
      touchSave();
      render();
      alert("Import complete.");
    }catch(e){
      alert("Import failed. Please choose a valid backup JSON.");
    }
  };
  reader.readAsText(file);
}
function exportCSV(){
  // Export all strength sets + treadmill logs
  const unit = state.data.settings.unit || "kg";
  let rows = [];
  rows.push(["date","workout_title","item_type","item_name","set_no","weight_"+unit,"reps","rpe","treadmill_mode","treadmill_incline","treadmill_minutes","treadmill_calories","bg_start","bg_end","workout_notes","item_notes"].join(","));
  for(const w of state.data.workouts){
    for(const it of (w.items||[])){
      if(it.type==="Strength"){
        (it.sets||[]).forEach((s, idx)=>{
          rows.push([
            w.dateISO,
            csv(w.title),
            "Strength",
            csv(it.name),
            idx+1,
            safeNumber(s.weight),
            safeNumber(s.reps),
            (s.rpe==null? "" : safeNumber(s.rpe)),
            "", "", "", "",
            csv(w.bgStart||""), csv(w.bgEnd||""),
            csv(w.notes||""), csv(it.notes||"")
          ].join(","));
        });
        if(!(it.sets||[]).length){
          rows.push([w.dateISO,csv(w.title),"Strength",csv(it.name),"","","","","","","","",csv(w.bgStart||""),csv(w.bgEnd||""),csv(w.notes||""),csv(it.notes||"")].join(","));
        }
      } else if(it.type==="Treadmill"){
        rows.push([
          w.dateISO,
          csv(w.title),
          "Treadmill",
          csv(it.name||"Treadmill"),
          "",
          "", "", "",
          csv(it.cardio?.mode||""),
          csv(it.cardio?.incline||""),
          csv(it.cardio?.minutes||""),
          csv(it.cardio?.calories||""),
          csv(w.bgStart||""), csv(w.bgEnd||""),
          csv(w.notes||""), csv(it.notes||"")
        ].join(","));
      }
    }
    if(!(w.items||[]).length){
      rows.push([w.dateISO,csv(w.title),"","","","","","","","","","",csv(w.bgStart||""),csv(w.bgEnd||""),csv(w.notes||""),""].join(","));
    }
  }
  downloadFile(`gym-tracker-export-${todayISO()}.csv`, "text/csv", rows.join("\n"));

  function csv(s){
    s = (s ?? "").toString();
    if(s.includes(",") || s.includes('"') || s.includes("\n")){
      return `"${s.replace(/"/g,'""')}"`;
    }
    return s;
  }
}

/* -----------------------------
   Tools: Plate calculator
------------------------------ */
function plateCalc(targetTotal){
  const bar = safeNumber(state.data.settings.barWeight);
  const plates = (state.data.settings.plates || []).map(Number).filter(n=>n>0).sort((a,b)=>b-a);
  let target = safeNumber(targetTotal);
  if(target < bar) return {bar, eachSide:0, plates:[]};

  let eachSide = (target - bar) / 2;
  // round to nearest 0.25 just to be safe
  eachSide = Math.round(eachSide * 4) / 4;

  let remaining = eachSide;
  const used = [];
  for(const p of plates){
    let count = 0;
    while(remaining >= p - 1e-9){
      remaining = Math.round((remaining - p)*100)/100;
      count += 1;
    }
    if(count>0) used.push({plate:p, count});
  }
  return {bar, eachSide, used, remainder: remaining};
}

/* -----------------------------
   Rendering
------------------------------ */
function setTab(tab){
  state.tab = tab;
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.tab === tab);
  });
  render();
}

function render(){
  ensureActiveWorkout();
  // sync rest preset from settings (but keep current remaining if running)
  const preset = state.data.settings.restPreset || 60;
  if([60,120,180].includes(preset)){
    state.rest.preset = preset;
    if(!state.rest.isRunning && state.rest.remaining !== preset){
      state.rest.remaining = preset;
    }
  } else {
    restSetPreset(60);
  }
  updateTimerBubble();

  if(state.tab==="workout") renderWorkout();
  if(state.tab==="history") renderHistory();
  if(state.tab==="progress") renderProgress();
  if(state.tab==="library") renderLibrary();
  if(state.tab==="tools") renderTools();
  if(state.tab==="settings") renderSettings();

  if(state.ui.focusId){
    const id = state.ui.focusId;
    state.ui.focusId = null;
    setTimeout(()=>{ const node = document.getElementById(id); if(node) node.focus(); }, 0);
  }
}

/* -----------------------------
   Workout tab
------------------------------ */
function renderWorkout(){
  const w = getActiveWorkout();
  const unit = state.data.settings.unit || "kg";

  main.innerHTML = "";
  const totals = workoutTotals(w);

  main.appendChild(el("div",{class:"card"},[
    el("div",{class:"card-h"},[
      el("div",{},[
        el("div",{class:"t"},["Active workout"]),
        el("div",{class:"k mono"},[`${formatUKDate(w.dateISO)} ‚Ä¢ ${w.title || defaultWorkoutTitle(w.dateISO)}`])
      ]),
      el("span",{class:"pill mono"},[`Sets: ${totals.strengthSets} ‚Ä¢ Vol: ${Math.round(totals.volume).toLocaleString()}`]),
      w.locked ? el("span",{class:"pill"},["Locked"]) : null
    ]),
    el("div",{class:"card-b"},[
      el("div",{class:"split"},[
        el("div",{class:"field"},[
          el("label",{},["Date (DD/MM/YYYY)"]),
          el("div",{class:"row"},[
            el("input",{
              id:"workoutDate",
              type:"date",
              value:w.dateISO,
              disabled: (w.locked || w.lockToToday) ? "disabled" : null,
              onchange:(e)=>{
                const old = w.dateISO;
                w.dateISO = e.target.value || todayISO();
                if(isDefaultTitle(w.title) || w.title === defaultWorkoutTitle(old)){
                  w.title = defaultWorkoutTitle(w.dateISO);
                }
                touchSave();
              }
            }),
            el("button",{class:"btn small", disabled: w.locked ? "disabled":null, onclick:()=>{
              const old = w.dateISO;
              w.dateISO = todayISO();
              if(isDefaultTitle(w.title) || w.title === defaultWorkoutTitle(old)){
                w.title = defaultWorkoutTitle(w.dateISO);
              }
              touchSave(); render();
            }},["Today"])
          ]),
          el("div",{class:"row", style:"margin-top:8px"},[
            el("span",{class:"pill mono"},[formatUKDate(w.dateISO)]),
            el("label",{style:"display:flex;align-items:center;gap:10px;color:'var(--muted)';font-size:12px"},[
              el("input",{
                type:"checkbox",
                checked: w.lockToToday ? "checked":null,
                disabled: w.locked ? "disabled":null,
                onchange:(e)=>{
                  w.lockToToday = !!e.target.checked;
                  if(w.lockToToday){
                    const old = w.dateISO;
                    w.dateISO = todayISO();
                    if(isDefaultTitle(w.title) || w.title === defaultWorkoutTitle(old)){
                      w.title = defaultWorkoutTitle(w.dateISO);
                    }
                  }
                  touchSave(); render();
                }
              }),
              "Use today's date"
            ])
          ])
        ]),
        el("div",{class:"field"},[
          el("label",{},["Workout title"]),
          el("input",{
            id:"workoutTitle",
            type:"text",
            value: w.title || defaultWorkoutTitle(w.dateISO),
            disabled: w.locked ? "disabled":null,
            enterkeyhint:"done",
            oninput:(e)=>{ w.title = e.target.value; touchSave(); } // no rerender
          }),
          el("div",{class:"hint"},["Default is date + ‚ÄúGym‚Äù. You can overwrite it."])
        ])
      ]),

      el("div",{class:"item"},[
        el("div",{style:"font-weight:950"},["Blood glucose (manual)"]),
        el("div",{class:"hint"},["Enter start/end for tracking."]),
        el("div",{class:"split", style:"margin-top:10px"},[
          el("div",{class:"field"},[
            el("label",{},["Start"]),
            el("input",{inputmode:"decimal", placeholder:"e.g. 6.2", value:w.bgStart||"", disabled:w.locked?"disabled":null,
              oninput:(e)=>{ w.bgStart = e.target.value; touchSave(); }
            })
          ]),
          el("div",{class:"field"},[
            el("label",{},["End"]),
            el("input",{inputmode:"decimal", placeholder:"e.g. 5.4", value:w.bgEnd||"", disabled:w.locked?"disabled":null,
              oninput:(e)=>{ w.bgEnd = e.target.value; touchSave(); }
            })
          ])
        ])
      ]),

      el("div",{class:"field"},[
        el("label",{},["Session notes (optional)"]),
        el("textarea",{disabled:w.locked?"disabled":null, placeholder:"Notes‚Ä¶", oninput:(e)=>{ w.notes = e.target.value; touchSave(); }},[w.notes||""])
      ]),

      el("div",{class:"divider"}),

      // Templates + quick add
      el("div",{class:"item"},[
        el("div",{class:"row"},[
          el("div",{style:"font-weight:950"},["Add items"]),
          el("span",{class:"pill"},["Templates + library"])
        ]),
        el("div",{class:"row", style:"margin-top:10px"},[
          el("button",{class:"btn primary", disabled:w.locked?"disabled":null, onclick:()=>openTemplatePicker(w)},["Use template"]),
          el("button",{class:"btn", disabled:w.locked?"disabled":null, onclick:()=>openAddItemSheet(w)},["Add from library"]),
          el("button",{class:"btn", disabled:w.locked?"disabled":null, onclick:()=>{
            const it = addItemToWorkout(w,"Strength","");
            touchSave();
            render();
            // focus name field on new item
            setTimeout(()=>{ const f = document.getElementById(`name-${it.id}`); if(f) f.focus(); }, 50);
          }},["+ Strength blank"]),
          el("button",{class:"btn", disabled:w.locked?"disabled":null, onclick:()=>{
            addItemToWorkout(w,"Treadmill","Treadmill");
            touchSave(); render();
          }},["+ Treadmill"])
        ]),
        el("div",{class:"hint"},["Tip: Add from library for consistent naming (cleaner progress charts)."])
      ]),

      (w.items||[]).length
        ? el("div",{style:"margin-top:12px"}, w.items.map(it => renderItem(w,it,unit)))
        : el("div",{class:"empty", style:"margin-top:12px"},["No items yet. Use template or add from library."]),

      el("div",{class:"row", style:"margin-top:12px"},[
        !w.locked ? el("button",{class:"btn primary", onclick:()=>completeWorkout(w)},["Finish workout (lock)"]) : null,
        w.locked ? el("button",{class:"btn warn", onclick:()=>unlockWorkout(w)},["Unlock to edit"]) : null
      ])
    ])
  ]));
}

function renderItem(w, it, unit){
  if(it.type==="Treadmill") return renderTreadmill(w,it);
  return renderStrength(w,it,unit);
}

function renderTreadmill(w,it){
  const c = it.cardio || (it.cardio={mode:"Walk",incline:"",calories:"",minutes:"",speed:""});

  return el("div",{class:"item"},[
    el("div",{class:"row"},[
      el("div",{style:"font-weight:950;font-size:15px"},[it.name||"Treadmill"]),
      el("span",{class:"pill"},["Treadmill"]),
      el("button",{class:"btn small danger right", disabled:w.locked?"disabled":null, onclick:()=>{
        if(confirm(`Delete "${it.name||"Treadmill"}"?`)){
          deleteItem(w,it.id); touchSave(); render();
        }
      }},["Delete"])
    ]),
    el("div",{class:"split3", style:"margin-top:10px"},[
      el("div",{class:"field"},[
        el("label",{},["Walk/Run"]),
        el("select",{disabled:w.locked?"disabled":null, onchange:(e)=>{ c.mode=e.target.value; touchSave(); }},[
          el("option",{value:"Walk", selected:c.mode==="Walk"?"selected":null},["Walk"]),
          el("option",{value:"Run", selected:c.mode==="Run"?"selected":null},["Run"])
        ])
      ]),
      el("div",{class:"field"},[
        el("label",{},["Incline (%)"]),
        el("input",{disabled:w.locked?"disabled":null, inputmode:"decimal", placeholder:"e.g. 8", value:c.incline??"",
          oninput:(e)=>{ c.incline=e.target.value; touchSave(); }
        })
      ]),
      el("div",{class:"field"},[
        el("label",{},["Speed (optional)"]),
        el("input",{disabled:w.locked?"disabled":null, inputmode:"decimal", placeholder:"e.g. 6.0", value:c.speed??"",
          oninput:(e)=>{ c.speed=e.target.value; touchSave(); }
        })
      ])
    ]),
    el("div",{class:"split",},[
      el("div",{class:"field"},[
        el("label",{},["Time (minutes)"]),
        el("input",{disabled:w.locked?"disabled":null, inputmode:"numeric", placeholder:"e.g. 20", value:c.minutes??"",
          oninput:(e)=>{ c.minutes=e.target.value; touchSave(); }
        })
      ]),
      el("div",{class:"field"},[
        el("label",{},["Calories"]),
        el("input",{disabled:w.locked?"disabled":null, inputmode:"numeric", placeholder:"e.g. 180", value:c.calories??"",
          oninput:(e)=>{ c.calories=e.target.value; touchSave(); }
        })
      ])
    ]),
    el("div",{class:"field"},[
      el("label",{},["Notes (optional)"]),
      el("input",{disabled:w.locked?"disabled":null, placeholder:"e.g. 6km/h, steady HR", value:it.notes||"",
        oninput:(e)=>{ it.notes=e.target.value; touchSave(); }
      })
    ])
  ]);
}

function renderStrength(w,it,unit){
  // Smart quick actions use last set
  const last = (it.sets||[]).length ? it.sets[it.sets.length-1] : null;
  const nameId = `name-${it.id}`;
  const weightId = `wt-${it.id}`;
  const repsId = `rp-${it.id}`;
  const rpeId = `pe-${it.id}`;

  const locked = !!w.locked;

  const setsTable = (it.sets||[]).length ? el("table",{},[
    el("thead",{},[
      el("tr",{},[
        el("th",{},["Set"]),
        el("th",{},[`Weight (${unit})`]),
        el("th",{},["Reps"]),
        el("th",{},["RPE"]),
        el("th",{},[""])
      ])
    ]),
    el("tbody",{}, it.sets.map((s,idx)=> el("tr",{},[
      el("td",{class:"mono"},[String(idx+1)]),
      el("td",{},[
        el("input",{class:"setInput", type:"number", step:"0.5", min:"0", inputmode:"decimal",
          disabled:locked?"disabled":null,
          value:s.weight ?? 0,
          oninput:(e)=>{ s.weight = safeNumber(e.target.value); touchSave(); }
        })
      ]),
      el("td",{},[
        el("input",{class:"setInput small", type:"number", step:"1", min:"1", inputmode:"numeric",
          disabled:locked?"disabled":null,
          value:s.reps ?? 0,
          oninput:(e)=>{ s.reps = safeNumber(e.target.value); touchSave(); }
        })
      ]),
      el("td",{},[
        el("input",{class:"setInput small", type:"number", step:"0.5", min:"0", max:"10", inputmode:"decimal",
          disabled:locked?"disabled":null,
          value:(s.rpe==null?"":s.rpe),
          placeholder:"‚Äî",
          oninput:(e)=>{ s.rpe = (e.target.value===""?null:safeNumber(e.target.value)); touchSave(); }
        })
      ]),
      el("td",{},[
        el("button",{class:"btn small danger", disabled:locked?"disabled":null, onclick:()=>{
          const removed = it.sets.splice(idx,1)[0];
          showUndo(`Removed set ${idx+1} (${it.name})`, ()=> it.sets.splice(idx,0,removed));
          touchSave(); render();
        }},["Remove"])
      ])
    ])))
  ]) : el("div",{class:"empty"},["No sets yet. Add your first set below."]);

  return el("div",{class:"item"},[
    el("div",{class:"row"},[
      el("div",{style:"font-weight:950;font-size:15px"},["Strength"]),
      el("span",{class:"pill mono"},[`${(it.sets||[]).length} sets`]),
      el("button",{class:"btn small right", onclick:()=>openProgressForExercise(it.name)},["Chart"]),
      el("button",{class:"btn small danger", disabled:locked?"disabled":null, onclick:()=>{
        if(confirm(`Delete "${it.name||"Strength"}"?`)){
          deleteItem(w,it.id); touchSave(); render();
        }
      }},["Delete"])
    ]),

    // Name with suggestions + star toggle
    el("div",{class:"field suggest", style:"margin-top:10px"},[
      el("label",{},["Exercise name"]),
      el("input",{
        id:nameId,
        type:"text",
        placeholder:"e.g. Bench Press",
        value: it.name || "",
        disabled:locked?"disabled":null,
        onfocus:()=>openSuggest(nameId, it, "Strength"),
        oninput:(e)=>{ it.name=e.target.value; touchSave(); openSuggest(nameId, it, "Strength"); }
      }),
      el("div",{class:"hint"},["Use consistent naming for clean progress charts."])
    ]),

    el("div",{class:"field"},[
      el("label",{},["Notes (optional)"]),
      el("input",{disabled:locked?"disabled":null, placeholder:"cues, tempo, PR attempt‚Ä¶", value:it.notes||"",
        oninput:(e)=>{ it.notes=e.target.value; touchSave(); }
      })
    ]),

    // Quick actions row
    el("div",{class:"row"},[
      el("span",{class:"pill"},["Quick add"]),
      el("button",{class:"btn small", disabled:locked?"disabled":null, onclick:()=>{
        if(!last) return alert("No last set yet.");
        // copy last set into inputs
        document.getElementById(weightId).value = last.weight ?? 0;
        document.getElementById(repsId).value = last.reps ?? 0;
        document.getElementById(rpeId).value = (last.rpe==null?"":last.rpe);
        state.ui.focusId = repsId;
      }},["Copy last"]),
      el("button",{class:"btn small", disabled:locked?"disabled":null, onclick:()=>bumpWeight(weightId, 2.5)},["+2.5"]),
      el("button",{class:"btn small", disabled:locked?"disabled":null, onclick:()=>bumpWeight(weightId, 5)},["+5"]),
      el("button",{class:"btn small", disabled:locked?"disabled":null, onclick:()=>bumpReps(repsId, 1)},["+1 rep"]),
      el("button",{class:"btn small", onclick:()=>openPlateCalculator()},["Plates"])
    ]),

    // Add set inputs
    el("div",{class:"split", style:"margin-top:10px"},[
      el("div",{class:"field"},[
        el("label",{},[`Weight (${unit})`]),
        el("input",{id:weightId, type:"number", step:"0.5", min:"0", inputmode:"decimal", disabled:locked?"disabled":null,
          placeholder:last ? `Last ${last.weight}` : "e.g. 60",
          enterkeyhint:"next",
          onkeydown:(ev)=>{ if(ev.key==="Enter"){ ev.preventDefault(); document.getElementById(repsId).focus(); } }
        })
      ]),
      el("div",{class:"field"},[
        el("label",{},["Reps"]),
        el("input",{id:repsId, type:"number", step:"1", min:"1", inputmode:"numeric", disabled:locked?"disabled":null,
          placeholder:last ? `Last ${last.reps}` : "e.g. 8",
          enterkeyhint:"next",
          onkeydown:(ev)=>{ if(ev.key==="Enter"){ ev.preventDefault(); document.getElementById(rpeId).focus(); } }
        })
      ])
    ]),
    el("div",{class:"row"},[
      el("div",{class:"field", style:"flex:1;margin:0"},[
        el("label",{},["RPE (optional)"]),
        el("input",{id:rpeId, type:"number", step:"0.5", min:"0", max:"10", inputmode:"decimal", disabled:locked?"disabled":null,
          placeholder:"e.g. 8.5",
          enterkeyhint:"done",
          onkeydown:(ev)=>{ if(ev.key==="Enter"){ ev.preventDefault(); document.getElementById(`addSet-${it.id}`).click(); } }
        })
      ]),
      el("button",{id:`addSet-${it.id}`, class:"btn primary", disabled:locked?"disabled":null, onclick:()=>{
        const weight = safeNumber(document.getElementById(weightId).value);
        const reps = safeNumber(document.getElementById(repsId).value);
        const rpeRaw = document.getElementById(rpeId).value;
        const rpe = rpeRaw===""? null : safeNumber(rpeRaw);
        if(reps<=0) return alert("Please enter reps (1 or more).");
        addSet(w,it.id,{weight,reps,rpe});
        document.getElementById(weightId).value="";
        document.getElementById(repsId).value="";
        document.getElementById(rpeId).value="";
        touchSave();
        state.ui.focusId = weightId;
        render();
      }},["Add set"])
    ]),

    el("div",{style:"margin-top:10px"},[setsTable])
  ]);

  function bumpWeight(inputId, inc){
    const elx = document.getElementById(inputId);
    const cur = safeNumber(elx.value || 0);
    elx.value = (cur + inc).toFixed(1).replace(/\.0$/,"");
    elx.focus();
  }
  function bumpReps(inputId, inc){
    const elx = document.getElementById(inputId);
    const cur = safeNumber(elx.value || 0);
    elx.value = String(cur + inc);
    elx.focus();
  }
}

/* -----------------------------
   Suggest UI for naming
------------------------------ */
function openSuggest(anchorId, item, type){
  const anchor = document.getElementById(anchorId);
  if(!anchor) return;

  const q = anchor.value || "";
  const matches = suggestMatches(q, type);

  // close existing list if none
  const wrap = anchor.closest(".suggest");
  const existing = wrap.querySelector(".suggest-list");
  if(existing) existing.remove();

  if(!matches.length) return;

  const list = el("div",{class:"suggest-list"}, matches.map(m=>{
    const isFav = !!m.favorite;
    return el("div",{class:"suggest-item", onclick:()=>{
      item.name = m.name;
      touchSave();
      // add item name and close list
      const w = anchor.closest(".suggest");
      const l = w.querySelector(".suggest-list");
      if(l) l.remove();
      anchor.value = m.name;
    }},[
      el("div",{},[
        el("div",{style:"font-weight:850"},[m.name]),
        el("div",{class:"kbd"},[m.category ? m.category : m.type])
      ]),
      el("button",{class:"btn small", onclick:(ev)=>{
        ev.stopPropagation();
        toggleFavorite(m.id);
        openSuggest(anchorId, item, type);
      }},[isFav ? "‚òÖ" : "‚òÜ"])
    ]);
  }));

  wrap.appendChild(list);

  // close when tapping elsewhere
  const close = (ev)=>{
    if(!wrap.contains(ev.target)){
      const l = wrap.querySelector(".suggest-list");
      if(l) l.remove();
      document.removeEventListener("click", close);
    }
  };
  setTimeout(()=>document.addEventListener("click", close), 0);
}

/* -----------------------------
   History tab: search, copy, lock, delete
------------------------------ */
function cloneWorkoutAsTemplate(w){
  const d = todayISO();
  return {
    id: uid(),
    dateISO: d,
    lockToToday: false,
    title: defaultWorkoutTitle(d),
    notes:"",
    bgStart:"",
    bgEnd:"",
    completedAt:null,
    locked:false,
    items: (w.items||[]).map(it=>({
      id: uid(),
      type: it.type,
      name: it.name,
      notes: it.notes || "",
      sets: [],
      cardio: { mode:"Walk", incline:"", calories:"", minutes:"", speed:"" }
    }))
  };
}

function renderHistory(){
  const ws = [...state.data.workouts].sort((a,b)=> (b.dateISO||"").localeCompare(a.dateISO||""));
  main.innerHTML = "";

  let searchVal = state.historySearch || "";
  const head = el("div",{class:"card"},[
    el("div",{class:"card-h"},[
      el("div",{},[
        el("div",{class:"t"},["History"]),
        el("div",{class:"k"},["Search, open, copy templates, export"])
      ]),
      el("button",{class:"btn primary small", onclick:()=>{
        const nw = createWorkout(todayISO());
        state.activeWorkoutId = nw.id;
        touchSave();
        setTab("workout");
      }},["New"])
    ]),
    el("div",{class:"card-b"},[
      el("div",{class:"split"},[
        el("div",{class:"field"},[
          el("label",{},["Search"]),
          el("input",{placeholder:"Search workouts, exercise names, notes‚Ä¶", value:searchVal,
            oninput:(e)=>{ state.historySearch = e.target.value; renderHistory(); }
          })
        ]),
        el("div",{class:"field"},[
          el("label",{},["Backup"]),
          el("div",{class:"row"},[
            el("button",{class:"btn", onclick:exportJSON},["Export JSON"]),
            el("button",{class:"btn", onclick:exportCSV},["Export CSV"]),
            el("button",{class:"btn", onclick:()=>openImportSheet()},["Import"])
          ])
        ])
      ]),
      el("div",{class:"hint"},["Tip: Export JSON occasionally so you can restore on a new phone."])
    ])
  ]);
  main.appendChild(head);

  const q = normalizeName(searchVal);
  const filtered = q ? ws.filter(w=>{
    if(normalizeName(w.title).includes(q)) return true;
    if(normalizeName(w.notes).includes(q)) return true;
    for(const it of (w.items||[])){
      if(normalizeName(it.name).includes(q)) return true;
      if(normalizeName(it.notes).includes(q)) return true;
    }
    return false;
  }) : ws;

  const listCard = el("div",{class:"card"},[
    el("div",{class:"card-h"},[
      el("div",{},[
        el("div",{class:"t"},["Workouts"]),
        el("div",{class:"k"},[`${filtered.length} shown`])
      ])
    ]),
    el("div",{class:"card-b"},[
      filtered.length ? el("div",{}, filtered.map(w=>{
        const t = workoutTotals(w);
        const treadmillCount = (w.items||[]).filter(i=>i.type==="Treadmill").length;
        return el("div",{class:"item"},[
          el("div",{class:"row"},[
            el("div",{},[
              el("div",{style:"font-weight:950"},[w.title || defaultWorkoutTitle(w.dateISO)]),
              el("div",{class:"k mono", style:"margin-top:3px;color:'var(--muted)';font-size:12px"},[formatUKDate(w.dateISO)])
            ]),
            w.locked ? el("span",{class:"pill"},["Locked"]) : null,
            el("span",{class:"pill mono right"},[`Sets: ${t.strengthSets}`]),
            el("span",{class:"pill mono"},[`Treadmill: ${treadmillCount}`]),
          ]),
          el("div",{class:"row", style:"margin-top:10px"},[
            el("span",{class:"pill"},[`BG start: ${w.bgStart||"‚Äî"}`]),
            el("span",{class:"pill"},[`BG end: ${w.bgEnd||"‚Äî"}`])
          ]),
          el("div",{class:"row", style:"margin-top:10px"},[
            el("button",{class:"btn small", onclick:()=>{ state.activeWorkoutId = w.id; setTab("workout"); }},["Open"]),
            el("button",{class:"btn small", onclick:()=>{
              const copy = cloneWorkoutAsTemplate(w);
              state.data.workouts.push(copy);
              state.activeWorkoutId = copy.id;
              touchSave();
              setTab("workout");
            }},["Copy template"]),
            el("button",{class:"btn small danger", onclick:()=>{
              if(confirm(`Delete "${w.title||"Workout"}"?`)){
                deleteWorkout(w.id);
                touchSave();
                renderHistory();
              }
            }},["Delete"])
          ]),
          w.notes ? el("div",{class:"hint"},[w.notes]) : null
        ]);
      })) : el("div",{class:"empty"},["No workouts yet."])
    ])
  ]);
  main.appendChild(listCard);
}

function openImportSheet(){
  const input = el("input",{type:"file", accept:"application/json"});
  const body = el("div",{},[
    el("div",{class:"item"},[
      el("div",{style:"font-weight:950"},["Import backup"]),
      el("div",{class:"hint"},["Choose a JSON backup exported from this app. This will replace current data on this device."]),
      el("div",{class:"row", style:"margin-top:10px"},[
        input,
        el("button",{class:"btn danger", onclick:()=>{ 
          if(confirm("This will overwrite your current data. Continue?")){
            localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultData()));
            state.data = loadData();
            state.activeWorkoutId = null;
            ensureActiveWorkout();
            touchSave(); render();
            closeSheet();
          }
        }},["Reset data"])
      ]),
      el("div",{class:"row", style:"margin-top:10px"},[
        el("button",{class:"btn primary", onclick:()=>{
          const file = input.files && input.files[0];
          if(!file) return alert("Please choose a file first.");
          if(!confirm("Import this backup and overwrite current data?")) return;
          importJSONFromFile(file);
          closeSheet();
        }},["Import"])
      ])
    ])
  ]);
  openSheet("Import", "Restore from a backup JSON", body);
}

/* -----------------------------
   Progress tab: Strength + Cardio + Glucose + Weekly + Bodyweight
------------------------------ */
function renderProgress(){
  const unit = state.data.settings.unit || "kg";
  main.innerHTML = "";

  const strengthNames = getAllStrengthExerciseNames();
  const selected = state.progressSelected && strengthNames.includes(state.progressSelected)
    ? state.progressSelected : (strengthNames[0] || "");

  const weeks = weeklyTotals();
  const gl = glucoseSeries();
  const tm = treadmillSeries();
  const ms = measurementsSeries();

  main.appendChild(el("div",{class:"card"},[
    el("div",{class:"card-h"},[
      el("div",{},[
        el("div",{class:"t"},["Progress dashboard"]),
        el("div",{class:"k"},["Strength ‚Ä¢ cardio ‚Ä¢ glucose ‚Ä¢ bodyweight"])
      ])
    ]),
    el("div",{class:"card-b"},[
      el("div",{class:"item"},[
        el("div",{style:"font-weight:950"},["Strength chart"]),
        strengthNames.length ? el("div",{class:"field", style:"margin-top:10px"},[
          el("label",{},["Exercise"]),
          el("select",{onchange:(e)=>{ state.progressSelected = e.target.value; renderProgress(); }}, strengthNames.map(n=>
            el("option",{value:n, selected:n===selected?"selected":null},[n])
          ))
        ]) : el("div",{class:"empty"},["No strength data yet."])
      ]),

      strengthNames.length ? renderStrengthCharts(selected, unit) : null,

      el("div",{class:"divider"}),

      el("div",{class:"item"},[
        el("div",{style:"font-weight:950"},["Weekly totals"]),
        weeks.length ? el("div",{class:"chartwrap", style:"margin-top:10px"},[ el("canvas",{id:"weekVol"}) ]) : el("div",{class:"empty", style:"margin-top:10px"},["No history yet."]),
        el("div",{class:"hint"},["Volume is total weight√óreps across the week."])
      ]),

      el("div",{class:"divider"}),

      el("div",{class:"item"},[
        el("div",{style:"font-weight:950"},["Treadmill trends"]),
        tm.length ? el("div",{class:"chartwrap", style:"margin-top:10px"},[ el("canvas",{id:"tmMin"}) ]) : el("div",{class:"empty", style:"margin-top:10px"},["No treadmill logs yet."]),
        el("div",{class:"hint"},["Minutes per session over time."])
      ]),

      el("div",{class:"divider"}),

      el("div",{class:"item"},[
        el("div",{style:"font-weight:950"},["Glucose trends"]),
        gl.length ? el("div",{class:"chartwrap", style:"margin-top:10px"},[ el("canvas",{id:"bgDelta"}) ]) : el("div",{class:"empty", style:"margin-top:10px"},["No glucose entries yet."]),
        el("div",{class:"hint"},["Delta = end - start (per workout)."])
      ]),

      el("div",{class:"divider"}),

      el("div",{class:"item"},[
        el("div",{style:"font-weight:950"},["Bodyweight / measurements"]),
        el("div",{class:"row", style:"margin-top:10px"},[
          el("button",{class:"btn", onclick:openMeasurementSheet},["Add measurement"]),
        ]),
        ms.length ? el("div",{class:"chartwrap", style:"margin-top:10px"},[ el("canvas",{id:"bwChart"}) ]) : el("div",{class:"empty", style:"margin-top:10px"},["No measurements yet."])
      ])
    ])
  ]));

  // Draw charts
  setTimeout(()=>{
    if(strengthNames.length){
      const rows = exerciseSeries(selected);
      const best = rows.map(r=>({label:r.dateISO, y:r.bestWeight}));
      const e1 = rows.map(r=>({label:r.dateISO, y:r.bestE1RM}));
      const vol = rows.map(r=>({label:r.dateISO, y:r.volume}));
      const c1 = document.getElementById("stBest");
      const c2 = document.getElementById("stE1");
      const c3 = document.getElementById("stVol");
      if(c1) drawLineChart(c1,best,{title:selected, subtitle:`Best weight (${unit})`});
      if(c2) drawLineChart(c2,e1,{title:selected, subtitle:`Estimated 1RM (${unit})`});
      if(c3) drawLineChart(c3,vol,{title:selected, subtitle:`Volume (${unit}√óreps)`});
    }

    if(weeks.length){
      const pts = weeks.map(w=>({label:w.week, y:w.volume}));
      const c = document.getElementById("weekVol");
      if(c) drawLineChart(c, pts, {title:"Weekly volume", subtitle:"Sum of weight√óreps"});
    }

    if(tm.length){
      const pts = tm.map(r=>({label:r.dateISO, y:r.minutes}));
      const c = document.getElementById("tmMin");
      if(c) drawLineChart(c, pts, {title:"Treadmill minutes", subtitle:"Minutes per session"});
    }

    if(gl.length){
      const pts = gl.filter(r=>r.delta!=null).map(r=>({label:r.dateISO, y:r.delta}));
      const c = document.getElementById("bgDelta");
      if(c) drawLineChart(c, pts, {title:"Glucose delta", subtitle:"End - Start"});
    }

    if(ms.length){
      const pts = ms.filter(r=>r.weight!=null).map(r=>({label:r.dateISO, y:r.weight}));
      const c = document.getElementById("bwChart");
      if(c) drawLineChart(c, pts, {title:"Bodyweight", subtitle:"Over time"});
    }
  }, 0);
}

function renderStrengthCharts(exName, unit){
  const rows = exerciseSeries(exName);
  if(!rows.length) return el("div",{class:"empty", style:"margin-top:12px"},["No data yet for this exercise."]);
  return el("div",{style:"margin-top:12px"},[
    el("div",{class:"item"},[
      el("div",{class:"chartwrap"},[ el("canvas",{id:"stBest"}) ]),
      el("div",{class:"hint"},[`Best weight logged (${unit}).`])
    ]),
    el("div",{class:"item", style:"margin-top:12px"},[
      el("div",{class:"chartwrap"},[ el("canvas",{id:"stE1"}) ]),
      el("div",{class:"hint"},[`Estimated 1RM (${unit}) using Epley formula.`])
    ]),
    el("div",{class:"item", style:"margin-top:12px"},[
      el("div",{class:"chartwrap"},[ el("canvas",{id:"stVol"}) ]),
      el("div",{class:"hint"},[`Volume per session (weight√óreps).`])
    ])
  ]);
}

function openMeasurementSheet(){
  const w = { dateISO: todayISO(), weight:"", waist:"", notes:"" };
  const body = el("div",{},[
    el("div",{class:"item"},[
      el("div",{style:"font-weight:950"},["Add measurement"]),
      el("div",{class:"split", style:"margin-top:10px"},[
        el("div",{class:"field"},[
          el("label",{},["Date"]),
          el("input",{type:"date", value:w.dateISO, onchange:(e)=>{ w.dateISO = e.target.value || todayISO(); }})
        ]),
        el("div",{class:"field"},[
          el("label",{},["Bodyweight"]),
          el("input",{inputmode:"decimal", placeholder:"e.g. 84.2", oninput:(e)=>{ w.weight = e.target.value; }})
        ])
      ]),
      el("div",{class:"split",},[
        el("div",{class:"field"},[
          el("label",{},["Waist (optional)"]),
          el("input",{inputmode:"decimal", placeholder:"e.g. 34.5", oninput:(e)=>{ w.waist = e.target.value; }})
        ]),
        el("div",{class:"field"},[
          el("label",{},["Notes"]),
          el("input",{placeholder:"optional", oninput:(e)=>{ w.notes = e.target.value; }})
        ])
      ]),
      el("div",{class:"row"},[
        el("button",{class:"btn primary", onclick:()=>{
          state.data.measurements.push({id:uid(), ...w});
          touchSave();
          closeSheet();
          render();
        }},["Save"])
      ])
    ])
  ]);
  openSheet("Measurements", "Track weight/waist over time", body);
}

/* -----------------------------
   Library tab: manage favourites, add/edit exercises
------------------------------ */
function renderLibrary(){
  main.innerHTML = "";
  const list = librarySorted();

  main.appendChild(el("div",{class:"card"},[
    el("div",{class:"card-h"},[
      el("div",{},[
        el("div",{class:"t"},["Exercise library"]),
        el("div",{class:"k"},["Favourites power autocomplete + consistency"])
      ]),
      el("button",{class:"btn primary small", onclick:openAddLibraryExerciseSheet},["+ Add"])
    ]),
    el("div",{class:"card-b"},[
      el("div",{class:"split"},[
        el("div",{class:"field"},[
          el("label",{},["Search"]),
          el("input",{placeholder:"Search library‚Ä¶", value:state.libSearch||"", oninput:(e)=>{ state.libSearch=e.target.value; renderLibrary(); }})
        ]),
        el("div",{class:"field"},[
          el("label",{},["Filter"]),
          el("select",{onchange:(e)=>{ state.libFilter=e.target.value; renderLibrary(); }},[
            el("option",{value:"All", selected:(state.libFilter||"All")==="All"?"selected":null},["All"]),
            el("option",{value:"Strength", selected:state.libFilter==="Strength"?"selected":null},["Strength"]),
            el("option",{value:"Treadmill", selected:state.libFilter==="Treadmill"?"selected":null},["Treadmill"]),
            el("option",{value:"Fav", selected:state.libFilter==="Fav"?"selected":null},["Favourites"])
          ])
        ])
      ]),
      el("div",{class:"divider"}),

      (()=> {
        const q = normalizeName(state.libSearch||"");
        const f = state.libFilter||"All";
        const filtered = list.filter(x=>{
          if(f==="Strength" && x.type!=="Strength") return false;
          if(f==="Treadmill" && x.type!=="Treadmill") return false;
          if(f==="Fav" && !x.favorite) return false;
          if(q && !normalizeName(x.name).includes(q) && !normalizeName(x.category||"").includes(q)) return false;
          return true;
        });

        return filtered.length ? el("div",{}, filtered.map(ex=> el("div",{class:"item"},[
          el("div",{class:"row"},[
            el("div",{},[
              el("div",{style:"font-weight:950"},[ex.name]),
              el("div",{class:"k", style:"color:var(--muted);font-size:12px;margin-top:3px"},[`${ex.type} ‚Ä¢ ${ex.category||"General"}`])
            ]),
            el("button",{class:"btn small right", onclick:()=>{ toggleFavorite(ex.id); renderLibrary(); }},[ex.favorite ? "‚òÖ Favourite" : "‚òÜ Favourite"]),
            el("button",{class:"btn small danger", onclick:()=>{
              if(confirm(`Delete "${ex.name}" from library? (Existing workout logs remain.)`)){
                const idx = state.data.library.exercises.findIndex(e=>e.id===ex.id);
                const removed = state.data.library.exercises.splice(idx,1)[0];
                showUndo(`Library item deleted: ${removed.name}`, ()=> state.data.library.exercises.splice(idx,0,removed));
                touchSave(); renderLibrary();
              }
            }},["Delete"])
          ])
        ]))) : el("div",{class:"empty"},["Nothing matches."]);
      })()
    ])
  ]));

  // Templates manager (bonus)
  main.appendChild(renderTemplatesManagerCard());
}

function openAddLibraryExerciseSheet(){
  const tmp = { name:"", type:"Strength", category:"General", favorite:false };
  const body = el("div",{},[
    el("div",{class:"item"},[
      el("div",{style:"font-weight:950"},["Add to library"]),
      el("div",{class:"split", style:"margin-top:10px"},[
        el("div",{class:"field"},[
          el("label",{},["Type"]),
          el("select",{onchange:(e)=>tmp.type=e.target.value},[
            el("option",{value:"Strength"},["Strength"]),
            el("option",{value:"Treadmill"},["Treadmill"])
          ])
        ]),
        el("div",{class:"field"},[
          el("label",{},["Name"]),
          el("input",{placeholder:"e.g. Incline Walk", oninput:(e)=>tmp.name=e.target.value})
        ])
      ]),
      el("div",{class:"split"},[
        el("div",{class:"field"},[
          el("label",{},["Category"]),
          el("input",{placeholder:"e.g. Legs", oninput:(e)=>tmp.category=e.target.value})
        ]),
        el("div",{class:"field"},[
          el("label",{},["Favourite"]),
          el("select",{onchange:(e)=>tmp.favorite=(e.target.value==="Yes")},[
            el("option",{value:"No"},["No"]),
            el("option",{value:"Yes"},["Yes"])
          ])
        ])
      ]),
      el("div",{class:"row"},[
        el("button",{class:"btn primary", onclick:()=>{
          if(!tmp.name.trim()) return alert("Please enter a name.");
          state.data.library.exercises.push({id:uid(), ...tmp, name:tmp.name.trim()});
          touchSave();
          closeSheet();
          renderLibrary();
        }},["Add"])
      ])
    ])
  ]);
  openSheet("Library", "Add an exercise for quicker logging", body);
}

function renderTemplatesManagerCard(){
  const templates = state.data.templates || [];
  return el("div",{class:"card"},[
    el("div",{class:"card-h"},[
      el("div",{},[
        el("div",{class:"t"},["Templates"]),
        el("div",{class:"k"},["One tap to load your usual workouts"])
      ]),
      el("button",{class:"btn primary small", onclick:openCreateTemplateSheet},["+ New"])
    ]),
    el("div",{class:"card-b"},[
      templates.length ? el("div",{}, templates.map(tpl=> el("div",{class:"item"},[
        el("div",{class:"row"},[
          el("div",{},[
            el("div",{style:"font-weight:950"},[tpl.name]),
            el("div",{class:"k", style:"color:var(--muted);font-size:12px;margin-top:3px"},[`${tpl.items?.length||0} items`])
          ]),
          el("button",{class:"btn small right", onclick:()=>openEditTemplateSheet(tpl)},["Edit"]),
          el("button",{class:"btn small danger", onclick:()=>{
            if(confirm(`Delete template "${tpl.name}"?`)){
              const idx = state.data.templates.findIndex(x=>x.id===tpl.id);
              const removed = state.data.templates.splice(idx,1)[0];
              showUndo(`Template deleted: ${removed.name}`, ()=> state.data.templates.splice(idx,0,removed));
              touchSave(); renderLibrary();
            }
          }},["Delete"])
        ])
      ]))) : el("div",{class:"empty"},["No templates yet. Create one for your routine."])
    ])
  ]);
}

function openCreateTemplateSheet(){
  const tpl = { id:uid(), name:"", items:[] };
  openEditTemplateSheet(tpl, true);
}
function openEditTemplateSheet(tpl, isNew=false){
  const local = JSON.parse(JSON.stringify(tpl));
  function addRow(){
    local.items.push({type:"Strength", name:""});
    rerender();
  }
  function rerender(){
    const body = el("div",{},[
      el("div",{class:"item"},[
        el("div",{style:"font-weight:950"},[isNew ? "Create template" : "Edit template"]),
        el("div",{class:"field", style:"margin-top:10px"},[
          el("label",{},["Template name"]),
          el("input",{value:local.name, oninput:(e)=>{ local.name=e.target.value; }})
        ]),
        el("div",{class:"divider"}),

        el("div",{style:"font-weight:850"},["Items"]),
        el("div",{class:"hint"},["Use library names for consistency."]),
        el("div",{style:"margin-top:10px"}, local.items.map((it, idx)=> el("div",{class:"row", style:"margin-bottom:10px"},[
          el("select",{style:"max-width:140px", onchange:(e)=>{ it.type=e.target.value; }},[
            el("option",{value:"Strength", selected:it.type==="Strength"?"selected":null},["Strength"]),
            el("option",{value:"Treadmill", selected:it.type==="Treadmill"?"selected":null},["Treadmill"])
          ]),
          el("input",{style:"flex:1", placeholder:"e.g. Bench Press", value:it.name, oninput:(e)=>{ it.name=e.target.value; }}),
          el("button",{class:"btn small danger", onclick:()=>{ local.items.splice(idx,1); rerender(); }},["Remove"])
        ]))),
        el("div",{class:"row"},[
          el("button",{class:"btn", onclick:addRow},["+ Add item"]),
          el("button",{class:"btn primary right", onclick:()=>{
            if(!local.name.trim()) return alert("Name the template.");
            local.items = local.items.map(x=>({type:x.type, name:(x.name||"").trim()})).filter(x=>x.name);
            if(!local.items.length) return alert("Add at least one item.");
            if(isNew){
              state.data.templates.push(local);
            } else {
              const i = state.data.templates.findIndex(x=>x.id===tpl.id);
              if(i>=0) state.data.templates[i] = local;
            }
            touchSave();
            closeSheet();
            renderLibrary();
          }},[isNew ? "Create" : "Save"])
        ])
      ])
    ]);
    openSheet("Template", "Build one-tap routines", body);
  }
  rerender();
}

/* -----------------------------
   Workout: Template picker + add item sheet
------------------------------ */
function openTemplatePicker(w){
  const templates = state.data.templates || [];
  const body = el("div",{},[
    el("div",{class:"item"},[
      el("div",{style:"font-weight:950"},["Choose a template"]),
      el("div",{class:"hint"},["This adds items to the current workout."]),
      el("div",{style:"margin-top:10px"}, templates.map(tpl => el("div",{class:"row", style:"justify-content:space-between;padding:10px 0;border-bottom:'1px solid var(--line)'"},[
        el("div",{},[
          el("div",{style:"font-weight:900"},[tpl.name]),
          el("div",{class:"k", style:"color:var(--muted);font-size:12px;margin-top:3px"},[`${tpl.items?.length||0} items`])
        ]),
        el("button",{class:"btn small primary", onclick:()=>{
          applyTemplateToWorkout(w, tpl);
          touchSave();
          closeSheet();
          render();
        }},["Use"])
      ]))),
    ])
  ]);
  openSheet("Templates", "Pick one to load your routine", body);
}

function openAddItemSheet(w){
  const body = el("div",{},[
    el("div",{class:"item"},[
      el("div",{style:"font-weight:950"},["Add from library"]),
      el("div",{class:"hint"},["Tap to add. Favourites are shown first."]),
      el("div",{class:"field", style:"margin-top:10px"},[
        el("label",{},["Search"]),
        el("input",{placeholder:"Type to filter‚Ä¶", value:"", oninput:(e)=>rerender(e.target.value)})
      ]),
      el("div",{id:"libPickList"})
    ])
  ]);

  function rerender(q){
    const list = suggestMatches(q||"", null);
    const container = body.querySelector("#libPickList");
    container.innerHTML = "";
    container.appendChild(el("div",{}, list.map(ex => el("div",{class:"row", style:"justify-content:space-between;padding:10px 0;border-bottom:'1px solid var(--line)'"},[
      el("div",{},[
        el("div",{style:"font-weight:900"},[ex.name]),
        el("div",{class:"k", style:"color:var(--muted);font-size:12px;margin-top:3px"},[`${ex.type} ‚Ä¢ ${ex.category||"General"}`])
      ]),
      el("div",{class:"row"},[
        el("button",{class:"btn small", onclick:()=>{ toggleFavorite(ex.id); rerender(q); }},[ex.favorite?"‚òÖ":"‚òÜ"]),
        el("button",{class:"btn small primary", onclick:()=>{
          addItemToWorkout(w, ex.type, ex.name);
          touchSave();
          // keep sheet open for rapid adds
          render();
        }},["Add"])
      ])
    ]))));
  }
  rerender("");

  openSheet("Library", "Quick add to workout", body);
}

/* -----------------------------
   Tools tab: timers + plate calculator
------------------------------ */
function renderTools(){
  main.innerHTML = "";
  main.appendChild(el("div",{class:"card"},[
    el("div",{class:"card-h"},[
      el("div",{},[
        el("div",{class:"t"},["Tools"]),
        el("div",{class:"k"},["Timers, plates, utilities"])
      ])
    ]),
    el("div",{class:"card-b"},[
      el("div",{class:"item"},[
        el("div",{style:"font-weight:950"},["Rest timer (manual)"]),
        el("div",{class:"row", style:"margin-top:10px"},[
          presetBtn(60), presetBtn(120), presetBtn(180),
          el("span",{class:"pill mono right"},[`Remaining ${fmtTime(state.rest.remaining)}`])
        ]),
        el("div",{class:"row", style:"margin-top:10px"},[
          el("button",{class:"btn primary", onclick:restStart},["Start"]),
          el("button",{class:"btn", onclick:restPause},["Pause"]),
          el("button",{class:"btn", onclick:restReset},["Reset"]),
        ]),
        el("div",{class:"hint"},["When it hits 0 it beeps/vibrates and resets back to the selected preset."])
      ]),

      el("div",{class:"item", style:"margin-top:12px"},[
        el("div",{style:"font-weight:950"},["Stopwatch"]),
        el("div",{class:"row", style:"margin-top:10px"},[
          el("span",{class:"pill mono"},[fmtTime(state.stopwatch.elapsed/1000)]),
          el("span",{class:"pill"},[state.stopwatch.running ? "Running" : "Paused"])
        ]),
        el("div",{class:"row", style:"margin-top:10px"},[
          el("button",{class:"btn primary", onclick:stopwatchStart},["Start"]),
          el("button",{class:"btn", onclick:stopwatchPause},["Pause"]),
          el("button",{class:"btn", onclick:stopwatchReset},["Reset"]),
        ])
      ]),

      el("div",{class:"item", style:"margin-top:12px"},[
        el("div",{style:"font-weight:950"},["Interval timer"]),
        el("div",{class:"hint"},["Simple work/rest rounds (great for treadmill intervals)."]),
        el("div",{class:"split3", style:"margin-top:10px"},[
          fieldNum("Rounds", state.intervalTimer.rounds, (v)=>{ state.intervalTimer.rounds=clamp(v,1,50); }),
          fieldNum("Work (sec)", state.intervalTimer.workSec, (v)=>{ state.intervalTimer.workSec=clamp(v,5,3600); intervalReset(); }),
          fieldNum("Rest (sec)", state.intervalTimer.restSec, (v)=>{ state.intervalTimer.restSec=clamp(v,0,3600); intervalReset(); }),
        ]),
        el("div",{class:"row", style:"margin-top:10px"},[
          el("span",{class:"pill mono"},[`${state.intervalTimer.phase.toUpperCase()} ‚Ä¢ Round ${state.intervalTimer.round}/${state.intervalTimer.rounds}`]),
          el("span",{class:"pill mono"},[fmtTime(state.intervalTimer.remaining)])
        ]),
        el("div",{class:"row", style:"margin-top:10px"},[
          el("button",{class:"btn primary", onclick:intervalStart},["Start"]),
          el("button",{class:"btn", onclick:intervalPause},["Pause"]),
          el("button",{class:"btn", onclick:intervalReset},["Reset"]),
        ])
      ]),

      el("div",{class:"item", style:"margin-top:12px"},[
        el("div",{style:"font-weight:950"},["Plate calculator"]),
        el("div",{class:"hint"},["Enter target total weight, get plates per side."]),
        el("div",{class:"split", style:"margin-top:10px"},[
          el("div",{class:"field"},[
            el("label",{},["Target total weight"]),
            el("input",{id:"pcTarget", inputmode:"decimal", placeholder:"e.g. 100"})
          ]),
          el("div",{class:"field"},[
            el("label",{},["Bar weight"]),
            el("input",{inputmode:"decimal", value:state.data.settings.barWeight, oninput:(e)=>{ state.data.settings.barWeight = safeNumber(e.target.value); touchSave(); }})
          ])
        ]),
        el("div",{class:"row"},[
          el("button",{class:"btn primary", onclick:()=>{
            const v = safeNumber(document.getElementById("pcTarget").value);
            openPlateCalculator(v);
          }},["Calculate"]),
          el("span",{class:"hint"},["Plates in Settings can be edited."])
        ])
      ]),
    ])
  ]));

  function presetBtn(sec){
    const on = state.data.settings.restPreset===sec;
    return el("button",{class:"btn small "+(on?"primary":""), onclick:()=>{ restSetPreset(sec); restReset(); }},[fmtTime(sec)]);
  }
  function fieldNum(label, value, setter){
    return el("div",{class:"field"},[
      el("label",{},[label]),
      el("input",{inputmode:"numeric", value:String(value), oninput:(e)=>setter(safeNumber(e.target.value))})
    ]);
  }
}

function openPlateCalculator(target){
  const unit = state.data.settings.unit || "kg";
  const res = plateCalc(target);
  const body = el("div",{},[
    el("div",{class:"item"},[
      el("div",{style:"font-weight:950"},["Plate breakdown"]),
      el("div",{class:"hint"},[`Target ${target || "‚Äî"} ${unit} ‚Ä¢ Bar ${res.bar} ${unit}`]),
      el("div",{class:"divider"}),
      res.used?.length ? el("div",{}, res.used.map(u =>
        el("div",{class:"row", style:"justify-content:space-between;padding:8px 0;border-bottom:'1px solid var(--line)'"},[
          el("div",{style:"font-weight:850"},[`${u.plate} ${unit}`]),
          el("div",{class:"mono"},[`x${u.count} per side`])
        ])
      )) : el("div",{class:"empty"},["No plates needed (or target below bar)."]),
      res.remainder ? el("div",{class:"hint", style:"margin-top:10px"},[`Remainder each side: ${res.remainder} ${unit} (adjust plates list if needed)`]) : null
    ])
  ]);
  openSheet("Plates", "Per side loading", body);
}

/* -----------------------------
   Settings tab
------------------------------ */
function renderSettings(){
  main.innerHTML = "";
  const s = state.data.settings;

  main.appendChild(el("div",{class:"card"},[
    el("div",{class:"card-h"},[
      el("div",{},[
        el("div",{class:"t"},["Settings"]),
        el("div",{class:"k"},["Units, plates, backups"])
      ])
    ]),
    el("div",{class:"card-b"},[
      el("div",{class:"item"},[
        el("div",{style:"font-weight:950"},["Units"]),
        el("div",{class:"row", style:"margin-top:10px"},[
          el("select",{onchange:(e)=>{ s.unit=e.target.value; touchSave(); render(); }},[
            el("option",{value:"kg", selected:s.unit==="kg"?"selected":null},["kg"]),
            el("option",{value:"lb", selected:s.unit==="lb"?"selected":null},["lb"])
          ])
        ]),
        el("div",{class:"hint"},["Does not auto-convert old entries ‚Äî it keeps what you logged."])
      ]),

      el("div",{class:"item", style:"margin-top:12px"},[
        el("div",{style:"font-weight:950"},["Rest preset"]),
        el("div",{class:"row", style:"margin-top:10px"},[
          el("button",{class:"btn small "+(s.restPreset===60?"primary":""), onclick:()=>{ restSetPreset(60); restReset(); }},["01:00"]),
          el("button",{class:"btn small "+(s.restPreset===120?"primary":""), onclick:()=>{ restSetPreset(120); restReset(); }},["02:00"]),
          el("button",{class:"btn small "+(s.restPreset===180?"primary":""), onclick:()=>{ restSetPreset(180); restReset(); }},["03:00"]),
        ]),
        el("div",{class:"hint"},["Manual start. Resets to preset after finishing."])
      ]),

      el("div",{class:"item", style:"margin-top:12px"},[
        el("div",{style:"font-weight:950"},["Plate calculator settings"]),
        el("div",{class:"split"},[
          el("div",{class:"field"},[
            el("label",{},["Bar weight"]),
            el("input",{inputmode:"decimal", value:String(s.barWeight||20), oninput:(e)=>{ s.barWeight=safeNumber(e.target.value); touchSave(); }})
          ]),
          el("div",{class:"field"},[
            el("label",{},["Plates list (comma separated)"]),
            el("input",{value:(s.plates||[]).join(","), oninput:(e)=>{
              const arr = e.target.value.split(",").map(x=>parseFloat(x.trim())).filter(n=>Number.isFinite(n)&&n>0);
              s.plates = arr;
              touchSave();
            }})
          ])
        ]),
        el("div",{class:"hint"},["Example: 25,20,15,10,5,2.5,1.25"])
      ]),

      el("div",{class:"item", style:"margin-top:12px"},[
        el("div",{style:"font-weight:950"},["Backup"]),
        el("div",{class:"row", style:"margin-top:10px"},[
          el("button",{class:"btn", onclick:exportJSON},["Export JSON"]),
          el("button",{class:"btn", onclick:exportCSV},["Export CSV"]),
          el("button",{class:"btn", onclick:openImportSheet},["Import"])
        ]),
        el("div",{class:"hint"},["Export JSON occasionally. You can import it on a new phone."])
      ])
    ])
  ]));
}

/* -----------------------------
   Progress sheet shortcut
------------------------------ */
function openProgressForExercise(name){
  const unit = state.data.settings.unit || "kg";
  const rows = exerciseSeries(name);
  if(!rows.length){
    return openSheet("Progress", "No data yet for this exercise", el("div",{class:"empty"},["Log some sets first."]));
  }
  const ptsBest = rows.map(r=>({label:r.dateISO, y:r.bestWeight}));
  const ptsE1 = rows.map(r=>({label:r.dateISO, y:r.bestE1RM}));
  const ptsVol = rows.map(r=>({label:r.dateISO, y:r.volume}));

  const body = el("div",{},[
    el("div",{class:"chartwrap"},[ el("canvas",{id:"sheetBest"}) ]),
    el("div",{class:"hint"},[`Best weight (${unit}).`]),
    el("div",{class:"divider"}),
    el("div",{class:"chartwrap"},[ el("canvas",{id:"sheetE1"}) ]),
    el("div",{class:"hint"},[`Estimated 1RM (${unit}).`]),
    el("div",{class:"divider"}),
    el("div",{class:"chartwrap"},[ el("canvas",{id:"sheetVol"}) ]),
    el("div",{class:"hint"},[`Volume (${unit}√óreps).`]),
  ]);
  openSheet("Progress", name, body);

  setTimeout(()=>{
    const c1 = document.getElementById("sheetBest");
    const c2 = document.getElementById("sheetE1");
    const c3 = document.getElementById("sheetVol");
    if(c1) drawLineChart(c1, ptsBest, {title:name, subtitle:`Best weight (${unit})`});
    if(c2) drawLineChart(c2, ptsE1, {title:name, subtitle:`Estimated 1RM (${unit})`});
    if(c3) drawLineChart(c3, ptsVol, {title:name, subtitle:`Volume (${unit}√óreps)`});
  }, 0);
}

/* -----------------------------
   Timer bubble opens Tools sheet
------------------------------ */
document.getElementById("timerBubble").addEventListener("click", ()=>{
  const body = el("div",{},[
    el("div",{class:"item"},[
      el("div",{style:"font-weight:950"},["Rest timer"]),
      el("div",{class:"row", style:"margin-top:10px"},[
        el("button",{class:"btn small "+(state.data.settings.restPreset===60?"primary":""), onclick:()=>{ restSetPreset(60); restReset(); }},["01:00"]),
        el("button",{class:"btn small "+(state.data.settings.restPreset===120?"primary":""), onclick:()=>{ restSetPreset(120); restReset(); }},["02:00"]),
        el("button",{class:"btn small "+(state.data.settings.restPreset===180?"primary":""), onclick:()=>{ restSetPreset(180); restReset(); }},["03:00"]),
        el("span",{class:"pill mono right"},[fmtTime(state.rest.remaining)])
      ]),
      el("div",{class:"row", style:"margin-top:10px"},[
        el("button",{class:"btn primary", onclick:restStart},["Start"]),
        el("button",{class:"btn", onclick:restPause},["Pause"]),
        el("button",{class:"btn", onclick:restReset},["Reset"]),
      ])
    ]),
    el("div",{class:"item", style:"margin-top:12px"},[
      el("div",{style:"font-weight:950"},["Stopwatch"]),
      el("div",{class:"row", style:"margin-top:10px"},[
        el("span",{class:"pill mono", id:"swElapsed"},[fmtTime(state.stopwatch.elapsed/1000)]),
        el("span",{class:"pill"},[state.stopwatch.running ? "Running" : "Paused"])
      ]),
      el("div",{class:"row", style:"margin-top:10px"},[
        el("button",{class:"btn primary", onclick:stopwatchStart},["Start"]),
        el("button",{class:"btn", onclick:stopwatchPause},["Pause"]),
        el("button",{class:"btn", onclick:stopwatchReset},["Reset"]),
      ])
    ]),
    el("div",{class:"item", style:"margin-top:12px"},[
      el("div",{style:"font-weight:950"},["Intervals"]),
      el("div",{class:"row", style:"margin-top:10px"},[
        el("span",{class:"pill mono", id:"itPhase"},[`${state.intervalTimer.phase.toUpperCase()} ‚Ä¢ Round ${state.intervalTimer.round}/${state.intervalTimer.rounds}`]),
        el("span",{class:"pill mono", id:"itRemaining"},[fmtTime(state.intervalTimer.remaining)]),
      ]),
      el("div",{class:"row", style:"margin-top:10px"},[
        el("button",{class:"btn primary", onclick:intervalStart},["Start"]),
        el("button",{class:"btn", onclick:intervalPause},["Pause"]),
        el("button",{class:"btn", onclick:intervalReset},["Reset"]),
      ])
    ])
  ]);
  openSheet("Timers", "Rest ‚Ä¢ Stopwatch ‚Ä¢ Intervals", body);
});

/* -----------------------------
   Nav wiring
------------------------------ */
document.querySelectorAll(".tab").forEach(t=> t.addEventListener("click", ()=> setTab(t.dataset.tab)));

/* -----------------------------
   Init timers defaults
------------------------------ */
state.rest.preset = state.data.settings.restPreset || 60;
state.rest.remaining = state.rest.preset;
state.intervalTimer.remaining = state.intervalTimer.workSec;
updateTimerBubble();

/* -----------------------------
   PWA service worker
------------------------------ */
if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{
    if(location.protocol !== "file:"){
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    }
  });
}

/* -----------------------------
   Start
------------------------------ */
ensureActiveWorkout();
render();
localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));
setSaved("Saved");
</script>
</body>
</html>
